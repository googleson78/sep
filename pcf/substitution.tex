\begin{framed}
\begin{lemma}[Лема за замяната]\label{lem:pcf:substitution}
  Нека $\Gamma$ е типов контекст, $\tau$ и $\rho$ са термове, и
  \begin{align*}
    & \Gamma \vdash \rho : \vv{a}\\
    & \Gamma, \type{x}{a} \vdash \tau : \vv{b}.
  \end{align*}
  Тогава
  \begin{enumerate}[1)]
  \item
    $\Gamma \vdash \tau\subst{x}{\rho} : \vv{b}$;
  \item
    за всяко $\overline{u} \in \val{\Gamma}$,
    \[\val{\tau\subst{x}{\rho}}_\Gamma(\overline{u}) = \val{\tau}_{\Gamma'}(\overline{u},\val{\rho}_\Gamma),\]
    където $\Gamma' = \Gamma, \type{x}{a}$.  
  \end{enumerate}
\end{lemma}
\end{framed}
\begin{proof}
  Индукция по построението на термовете.
  
  \begin{itemize}
  \item
    Нека $\tau \equiv \tau_1 \tau_2$.
    Тук първата част е лесна. Понеже имаме, че
    \begin{prooftree}
      \AxiomC{$\Gamma, \type{x}{a} \vdash \tau_1: \vv{c} \to \vv{b}$}
      \AxiomC{$\Gamma, \type{x}{a} \vdash \tau_2: \vv{c}$}
      \BinaryInfC{$\Gamma, \type{x}{a} \vdash \tau_1 \tau_2 : \vv{b}$}
    \end{prooftree}
    то можем да приложим И.П. за да получим, че
    \begin{prooftree}
      \AxiomC{$\Gamma \vdash \rho : \vv{a}$}
      \AxiomC{$\Gamma, \type{x}{a} \vdash \tau_1: \vv{c} \to \vv{b}$}
      \LeftLabel{(И.П.)}
      \BinaryInfC{$\Gamma \vdash \tau_1\subst{\vv{x}}{\rho} : \vv{b}$}
      \AxiomC{$\Gamma \vdash \rho : \vv{a}$}
      \AxiomC{$\Gamma, \type{x}{a} \vdash \tau_2: \vv{c} \to \vv{b}$}
      \RightLabel{(И.П.)}
      \BinaryInfC{$\Gamma \vdash \tau_2\subst{x}{\rho} : \vv{c}$}
      \RightLabel{(app)}
      \BinaryInfC{$\Gamma \vdash \tau_1\subst{x}{\rho}(\tau_2\subst{x}{\rho}) : \vv{c}$}
      \RightLabel{(правила на замяна)}
      \UnaryInfC{$\Gamma \vdash \tau\subst{x}{\rho} : \vv{c}$}
    \end{prooftree}
    Втората част също е лесна.
    \begin{align*}
      \val{\tau_1\tau_2}_{\Gamma'}(\overline{u},\val{\rho}_\Gamma) & \dff \texttt{eval}(\val{\tau_1}_{\Gamma'}(\ov{u},\val{\rho}_\Gamma), \val{\tau_2}_{\Gamma'}(\ov{u},\val{\rho}_\Gamma)) & \comment\text{\Def{eval}}\\
                                                                   & = \texttt{eval}(\val{\tau_1\subst{x}{\rho}}_\Gamma(\ov{u}), \val{\tau_2\subst{x}{\rho}}_\Gamma(\ov{u})) & \comment\text{И.П.}\\
                                                                   & = \val{\tau_1\subst{x}{\rho}(\tau_2\subst{x}{\rho})}_\Gamma\\
                                                                   & = \val{\tau\subst{x}{\rho}}_\Gamma
    \end{align*}
  \item
    Нека $\tau \equiv \fix(\tau')$.
    Първо трябва да докажем, че $\Gamma \vdash \tau[\vv{x}/\rho] : \vv{b}$.
    От правилата за типизиране е ясно, че
    \begin{prooftree}
      \AxiomC{$\Gamma, \type{x}{a} \vdash \tau':\vv{b}\to\vv{b}$}
      \RightLabel{\scriptsize{(fix)}}
      \UnaryInfC{$\Gamma, \type{x}{a} \vdash \fix(\tau') : \vv{b}$}
    \end{prooftree}
    Сега можем да приложим И.П. за терма $\tau'$. Получаваме, че
    \begin{prooftree}
      \AxiomC{$\Gamma \vdash \rho: \vv{a}$}
      \AxiomC{$\Gamma, \type{x}{a} \vdash \tau':\vv{b}\to\vv{b}$}
      \RightLabel{\scriptsize{(И.П.)}}
      \BinaryInfC{$\Gamma \vdash \tau'\subst{x}{\rho} : \vv{b} \to \vv{b}$}
      \RightLabel{\scriptsize{(fix)}}
      \UnaryInfC{$\Gamma \vdash \fix(\tau'\subst{x}{\rho}) : \vv{b}$}
    \end{prooftree}
    Понеже $\fix(\tau'\subst{x}{\rho}) \equiv \fix(\tau')\subst{x}{\rho}$, то заключаваме, че
    \[\Gamma \vdash \tau[\vv{x}/\rho] : \vv{b}.\]
  \item
    Нека $\tau \equiv \lamb{y}{c}{\tau'}$, където $\vv{y} \not\in \vv{dom}(\Gamma) \cup \{\vv{x}\}$.
    Първо трябва да докажем, че $\Gamma \vdash \tau[\vv{x}/\rho] : \vv{b}$.
    
    От правилата за типизиране е ясно, че щом $\Gamma, \type{x}{a} \vdash \tau : \vv{b}$, то
    $\vv{b} = \vv{c} \to \vv{d}$ за някой тип $\vv{d}$ и
    \begin{prooftree}
      \AxiomC{$\vv{y} \not\in\vv{dom}(\Gamma)\cup\{\vv{x}\}$}
      \AxiomC{$\Gamma, \type{x}{a}, \type{y}{c} \vdash \tau':\vv{d}$}
      \RightLabel{\scriptsize{(lambda)}}
      \BinaryInfC{$\Gamma, \type{x}{a} \vdash \lamb{y}{c}{\tau'} : \vv{c}\to\vv{d}$}
    \end{prooftree}
    Това означава, че можем да използваме И.П. за терма $\tau'$ и така получаваме, че
    \begin{prooftree}
      \AxiomC{$\vv{y} \not\in \vv{dom}(\Gamma)$}
      \AxiomC{$\Gamma \vdash \rho : \vv{a}$}
      \UnaryInfC{$\Gamma,\type{y}{c} \vdash \rho : \vv{a}$}
      \AxiomC{$\Gamma, \type{y}{c}, \type{x}{a} \vdash \tau':\vv{d}$}
      \RightLabel{\scriptsize{(И.П.)}}
      \BinaryInfC{$\Gamma, \type{y}{c} \vdash \tau'\subst{x}{\rho} : \vv{d}$}
      \RightLabel{\scriptsize{(lambda)}}
      \BinaryInfC{$\Gamma \vdash \lamb{y}{c}{\tau'\subst{x}{\rho}}:\vv{c}\to\vv{d}$}
    \end{prooftree}
    Накрая, понеже $\tau\subst{x}{\rho} \equiv \lamb{y}{c}{\tau'\subst{x}{\rho}}$, то
    заключаваме, че
    \[\Gamma \vdash \tau\subst{x}{\rho}:\vv{b}.\]

    Нека $\Delta \dff \Gamma,\type{y}{c}$.
    Понеже имаме, че $\Delta \vdash \tau'\subst{x}{\rho} : \vv{d}$,
    то можем да приложим И.П. за $\tau'$ и така получаваме, че за всяко $\overline{u},v \in \val{\Delta}$,
    \begin{align*}
      \curry(\val{\tau'\subst{x}{\rho}}_\Delta)(\overline{u})(v) & \dff \val{\tau'\subst{x}{\rho}}_\Delta(\overline{u},v) & \comment\text{\Def{curry}}\\
                                                                 & \stackrel{\text{И.П.}}{=} \val{\tau'}_{\Delta'}(\overline{u},v,\val{\rho}_\Delta) & \comment \Delta' \dff \Gamma, \type{y}{c}, \type{x}{a}\\
                                                        & = \val{\tau'}_{\Delta'}(\overline{u},v,\val{\rho}_\Gamma) & \comment \fv(\rho) \subseteq \vv{dom}(\Gamma)\\
                                                        & = \val{\tau'}_{\Delta''}(\overline{u},\val{\rho}_\Gamma,v) & \comment \Delta'' \dff \Gamma, \type{x}{a}, \type{y}{c}\\
                                                        & = \curry(\val{\tau'}_{\Delta''})(\overline{u},\val{\rho}_\Gamma)(v) \\
                                                        & = \val{\lamb{y}{c}{\tau'}}_{\Gamma'}(\overline{u},\val{\rho}_\Gamma)(v). & \comment \Gamma' \dff \Gamma, \type{x}{a}
    \end{align*}    
    Така получихме, че
    \begin{align*}
      \val{\lamb{y}{c}{\tau'\subst{x}{\rho}}}_\Gamma(\overline{u}) & \dff \curry(\val{\tau'\subst{x}{\rho}}_\Delta)(\overline{u})\\
                                                                   & = \val{\lamb{y}{c}{\tau'}}_{\Gamma'}(\overline{u},\val{\rho}_\Gamma).
    \end{align*}
    
  \end{itemize}
\end{proof}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep"
%%% End:
