\subsection{Термални оператори}

Вече дефинирахме как на всеки терм $\tau[\vv{x}_1,\dots,\vv{x}_n,\vv{f}_1,\dots,\vv{f}_k]$
съпоставяме изображението $\val{\tau}$ със сигнатура
\[\val{\tau}:\Mapping{\Nat^{m_1}_\bot}{\Nat_\bot}\times\cdots\times\Mapping{\Nat^{m_k}_\bot}{\Nat_\bot} \to \Mapping{\Nat^n_\bot}{\Nat_\bot}\]
%  по следния начин:
% \[\Xi_\tau(\bar{\varphi})(\bar{a}) \dff \val{\tau}(\bar{a},\bar{\varphi}).\]
Едно от основните свойства, които трябва да притежават тези изображения е да бъдат {\em непрекъснати} относно областите на Скот,
за които са дефинирани.
Причината за това е, че искаме да дефинираме семантиката на една програма като използваме най-малкото решение 
на система от такива оператори, а според \hyperref[th:knaster-tarski]{Теоремата на Клини}, за да можем да направим това, трябва да работим
с непрекъснати оператори. Следващият пример ни показва, че трябва да сме по-внимателни върху какви елементи разглеждаждаме тези изображения.

\begin{example}
  \label{ex:non-continuous}
  Да разгледаме терма 
  \[\tau[\vv{x},\vv{f},\vv{g}] \dfff \vv{f}(\vv{g}(\vv{x})),\]
  и следните две изображения от тип $\Mapping{\Nat_\bot}{\Nat_\bot}$:
  \marginpar{Обърнете внимание, че $\varphi$ не е монотонна функция. Тя дори не е точна. 
    Функцията $\psi$ не е точна, но е монотонна. Знаем, че $\varphi$ не е непрекъсната}
  \begin{align*}
    & \varphi(x) \dff
    \begin{cases}
      42,   & \text{ако }x = \bot\\
      \bot, & \text{ако }x \in \Nat
    \end{cases}\\
    & \psi(x) \dff 42 \text{, за всяко }x \in \Nat_\bot.
  \end{align*}
  Лесно се вижда, че $\pair{\varphi,\varphi} \sqsubseteq \pair{\varphi,\psi}$, но
  \[\val{\tau}(\varphi,\varphi) \not\sqsubseteq \val{\tau}(\varphi,\psi),\]
  защото за произволно $a \in \Nat$,
  \begin{align*}
    \val{\tau}(\varphi,\varphi)(a) & = \varphi(\varphi(a)) & \comment{\text{стойност на терм}}\\
                                 & = 42  \\
                                 & \not\sqsubseteq \bot & \comment{\text{плоска наредба}}\\
                                 & = \varphi(\psi(a)) & \comment{\text{защото }\psi(a) \neq \bot}\\
                                 & = \val{\tau}(\varphi,\psi)(a) & \comment{\text{от деф. на }\tau}\\
  \end{align*}

  \marginpar{От \Prop{continuous-is-monotone} знаем, че всеки непрекъснат оператор е монотонен. 
    Щом $\val{\tau}$ не е монотоненно, то той със сигурност не е непрекъснато.}
  Това означава, че за конкретния терм $\tau$, изображението $\val{\tau}$ не е монотонно, откъдето следва, че той не е непрекъснато.
\end{example}

% Горният пример ни казва, че за $\val{\tau}$, дефинирани върху произволни елементи от $\Mapping{\Nat^{m_i}_\bot}{\Nat_\bot}$
% {\em не можем да гарантираме свойството непрекъснатост}. Ще видим, че ако се ограничим само до непрекъснатите изображения,
% то тогава операторите ще бъдат непрекъснати.
Всъщност на нас е необходимо да можем да подаваме като аргументи на $\val{\tau}$ само такива $\varphi$,
които можем да дефинираме на езика \REC.
Според семантиката на термовете, която дефинирахме по-горе, не е ясно дали можем да дефинираме терм на езика ${\bf REC}$, чиято семантика да бъде изображението $\varphi$. Естествено е да разгледаме терма 
\[\tau[\vv{x}] \dfff \ifelse{\vv{x}\ \vv{==}\ \bot}{42}{\bot}.\]
\marginpar{Това {\em не} е доказателство, че не можем да дефинираме функцията $\varphi$ на езика \REC. Тук ние твърдим само, че очевидният опит за дефиниция на $\varphi$ се проваля. По-нататък ще видим, че наистина не може да дефинираме $\varphi$ на нашия език, защото тя не е непрекъсната функция.}
 Каква е семантиката на този терм? Следваме дефиницията на стойност на терм, за произволно $a \in \Nat_\bot$, и получаваме:
 \begin{align*}
   \val{\tau}(a) & =
                   \begin{cases}
                     42,   & \text{ако }\val{\vv{x}\ \vv{==}\ \bot}(a) \in \Nat^+\\
                     \bot, & \text{ако }\val{\vv{x}\ \vv{==}\ \bot}(a) = 0\\
                     \bot, & \text{ако }\val{\vv{x}\ \vv{==}\ \bot}(a) = \bot\\
                   \end{cases}\\
                 & = 
                   \begin{cases}
                     42,   & \text{ако }\underbrace{\val{\vv{x}}(a)}_{\in\Nat} = \underbrace{\val{\bot}(a)}_{\in \Nat}\\
                     \bot, & \text{ако }\underbrace{\val{\vv{x}}(a)}_{\in\Nat} \neq \underbrace{\val{\bot}(a)}_{\in \Nat}\\
                     \bot, & \text{ако }\val{\vv{x}}(a) = \bot\text{ или }\val{\bot}(a) = \bot\\
                   \end{cases}\\
                 & = \bot.
 \end{align*}
 
Да видим, какво ще стане ако преведем директно горния пример на \vv{хаскел}.
\begin{haskellcode}
ghci> let phi(x) = if x == undefined then 42 else undefined
ghci> let psi(x) = 42
ghci> phi(0)
*** Exception: Prelude.undefined
ghci> phi(undefined)
*** Exception: Prelude.undefined
ghci> psi(0)
42
\end{haskellcode}

Виждаме, че тук \texttt{хаскел} следва нашата семантика за езика {\bf REC}.
Направените по-горе бележки ни насочват към следната дефиниция на {\bf термален оператор}.

\begin{framed}
  \begin{dfn}
    \index{термален оператор}
    За всеки терм от вида $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$
    дефинираме оператора 
    \[\Gamma_\tau: \DomOpCBN \to \RanOpCBN,\] % като
    където
    \[\Gamma_\tau(\bar{\varphi})(\bar{a}) \dff \val{\tau}(\ov{\varphi})(\ov{a}).\]
  \end{dfn}  
\end{framed}
\marginpar{Обърнете внимание, че все още не е ясно защо $\Gamma_\tau(\ov{\varphi}) \in \RanOpCBN$}
В следващия раздел ще се концентрираме върху доказателството на следния основен резултат:

\begin{framed}
  За всеки терм $\tau[\varsx, \varsf]$, операторът $\Gamma_\tau$ е непрекъснат.
\end{framed}

\subsection{Непрекъснатост на термалните оператори}

Първата ни задача ще бъде да проверим, че операторът $\Gamma_\tau$ е коректно дефиниран.
Това означава, че трябва да се уверим, че винаги когато подадем като аргументи на $\Gamma_\tau$ непрекъснати изображения,
то $\Gamma_\tau$ връща непрекъснато изображение.

\begin{remark}
  В този раздел всички доказателства се провеждат с индукция по построението на термовете.
\end{remark}

\begin{prop}
  \label{pr:term-monotone}
  Да разгледаме един терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
  \marginpar{Озн. $\ov{a}_i = (a^1_i,\dots,a^n_i)$}
  Нека $\ov{a} \sqsubseteq \ov{b}$.
  Тогава 
  \[\val{\tau}(\ov{\varphi})(\ov{a}) \sqsubseteq \val{\tau}(\ov{\varphi})(\ov{b}),\]
  където
  $\varphi_i \in \Cont{\Nat^{m_i}_\bot}{\Nat_\bot}$, за $i = 1,\dots,k$.
\end{prop}
\begin{hint}
  Индукция по построението на терма $\tau$.
  \begin{itemize}
  \item
    Нека $\tau \equiv \vv{c}$.
  \item
    Нека $\tau \equiv \vv{x}_i$. Тогава
    \begin{align*}
      \val{\tau}(\ov{\varphi})(\ov{a}) & = \val{\vv{x}_i}(\ov{\varphi})(\ov{a})\\
                                       & = a_i & \comment{\text{стойност на терм}}\\
                                       & \sqsubseteq b_i & \comment{\ov{a} \sqsubseteq \ov{b}}\\
                                       &= \val{\vv{x}_i}(\ov{\varphi})(\ov{b}) & \comment{\text{стойност на терм}}\\
                                       & = \val{\tau}(\ov{\varphi})(\ov{b}).
    \end{align*}
  \item
    Нека $\tau \equiv \tau_1 + \tau_2$. 
    Тук ще използваме, че от {\bf И.П.}, за $j = 1,2$, имаме
    \begin{equation}
      \label{eq:10}
      \val{\tau_j}(\ov{\varphi})(\ov{a}) \sqsubseteq \val{\tau_j}(\ov{\varphi})(\ov{b}).
    \end{equation}
    Освен това, понеже изображението $\texttt{plus}$ е непрекъснато, то то е и монотонно.
    \begin{align*}
      \val{\tau}(\ov{\varphi})(\ov{a}) & = \val{\tau_1 + \tau_2}(\ov{\varphi})(\ov{a})\\
                                       & \dff \texttt{plus}(\val{\tau_1}(\ov{\varphi})(\ov{a}), \val{\tau_2}(\ov{\varphi})(\ov{a}))\\
                                       & \sqsubseteq \texttt{plus}(\val{\tau_1}(\ov{\varphi})(\ov{b}), \val{\tau_2}(\ov{\varphi})(\ov{b})) & \comment{\text{от (\ref{eq:10}) и мон.}}\\
      & \dff \val{\tau_1 + \tau_2}(\ov{\varphi})(\ov{b}).
    \end{align*}
  \item
    \marginpar{\writedown За домашно!}
    Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$.
  \item
    Нека $\tau \equiv \ifelse{\tau_0}{\tau_1}{\tau_2}$.  
  \item
    Нека $\tau \equiv \vv{f}_i(\tau_1,\dots,\tau_{m_i})$. 
    Тук ще използваме, че от {\bf И.П.}, за $j = 1,\dots,m_i$, имаме
    \begin{equation}
      \label{eq:6}
      \val{\tau_j}(\ov{\varphi})(\ov{a}) \sqsubseteq \val{\tau_j}(\ov{\varphi})(\ov{b}).
    \end{equation}
    Тогава
    \begin{align*}
      \val{\tau}(\ov{\varphi})(\ov{a}) & = \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\ov{\varphi})(\ov{a})\\
                                      & \dff \varphi_i(\val{\tau_1}(\ov{\varphi})(\ov{a}), \dots, \val{\tau_{m_i}}(\ov{\varphi})(\ov{a}))\\
                                      & \sqsubseteq \varphi_i(\val{\tau_1}(\ov{b},\ov{\varphi}), \dots, \val{\tau_{m_i}}(\ov{a},\ov{\varphi})) & \comment{\text{от (\ref{eq:6}) и $\varphi_i$ е мон.}}\\
                                      & \dff \val{\tau}(\ov{\varphi})(\ov{b}).
    \end{align*}
  \end{itemize}
\end{hint}

\begin{cor}
  \label{cr:tau-preserves-continuous}
  Да разгледаме един терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
  Тогава за произволна верига $\chain{\bar{a}}{i}$ в $\Nat^{n}_\bot$,
  \[\val{\tau}(\ov{\varphi})(\bigsqcup_i\ov{a}_i) = \bigsqcup_i\val{\tau}(\ov{\varphi})(\ov{a}_i),\]
  където
  $\varphi_i \in \Cont{\Nat^{n_i}_\bot}{\Nat_\bot}$, за $i = 1,\dots,k$.
\end{cor}
\begin{proof}
  За терма $\tau$ и $\ov{\varphi}$, да разгледаме изображението
  \[\psi(\ov{a}) \dff \val{\tau}(\ov{\varphi})(\ov{a}).\]
  От \Prop{term-monotone} следва, че $\psi \in \Mon{\Nat^n_\bot}{\Nat_\bot}$.
  Понеже всяка верига в $\Nat^n_\bot$ се стабилизира, то директно от \Prop{stab-continuous}
  следва, че $\psi \in \Cont{\Nat^n_\bot}{\Nat_\bot}$,
  което означава, че за произволна верига $\chain{\ov{a}}{i}$,
  \[\psi(\bigsqcup_i \ov{a}_i) = \bigsqcup_i \psi(\ov{a}_i),\]
  което означава, че 
  \[\val{\tau}(\ov{\varphi})(\bigsqcup_i\ov{a}_i) = \bigsqcup_i\val{\tau}(\ov{\varphi})(\ov{a}_i).\]
\end{proof}

% \begin{prop}
%   Да разгледаме един терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
%   Тогава за произволна верига $\chain{\bar{a}}{i}$ в $\Nat^{n}_\bot$,
%   \marginpar{Озн. $\ov{a}_i = (a^1_i,\dots,a^n_i)$}
%   \[\val{\tau}(\bigsqcup_i\ov{a}_i,\ov{\varphi}) = \bigsqcup_i\val{\tau}(\ov{a}_i,\ov{\varphi}),\]
%   където
%   $\varphi_i \in \Cont{\Nat^{n_i}_\bot}{\Nat_\bot}$, за $i = 1,\dots,k$.
% \end{prop}
% \begin{hint}
%   \marginpar{Всъщност тук е достатъчно да се докаже, че $\val{\tau}(\ov{a},\ov{\varphi}) \sqsubseteq \val{\tau}(\ov{b},\ov{\varphi})$ за
%     произволни $\ov{a} \sqsubseteq \ov{b}$. От това директно следва непрекъснатост.}
%   Индукция по построението на терма $\tau$.
%   \begin{itemize}
%   \item
%     Нека $\tau \equiv \vv{c}$.
%   \item
%     Нека $\tau \equiv \vv{x}_i$. Тогава
%     \begin{align*}
%       \val{\tau}(\bigsqcup_k \bar{a}_k, \bar{\varphi}) & = \val{\vv{x}_i}(\bigsqcup_k \bar{a}_k, \bar{\varphi})\\
%       & = \bigsqcup_k a^i_k \\
%       & = \bigsqcup_k \underbrace{\val{\tau}(\bar{a}_k,\bar{\varphi})}_{a^i_k}.
%     \end{align*}
%   \item
%     Нека $\tau \equiv \tau_1 + \tau_2$.
%   \item
%     Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$.
%   \item
%     Нека $\tau \equiv \ifelse{\tau_0}{\tau_1}{\tau_2}$.  
%   \item
%     Нека $\tau \equiv \vv{f}_i(\tau_1,\dots,\tau_{m_i})$. Тогава
%     \begin{align*}
%       \val{\tau}(\bigsqcup_k\bar{a}_k,\bar{\varphi}) & = \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\bigsqcup_k\bar{a}_k,\bar{\varphi}) \\
%       & = \varphi_i(\val{\tau_1}(\bigsqcup_k\bar{a}_k,\bar{\varphi}), \dots, \val{\tau_{m_i}}(\bigsqcup_k\bar{a}_k,\bar{\varphi})) & \comment{\text{стойност на терм}}\\
%      & = \varphi_i(\bigsqcup_k \val{\tau_1}(\bar{a}_k,\bar{\varphi}), \dots, \bigsqcup_k \val{\tau_{m_i}}(\bar{a}_k,\bar{\varphi})) & \comment{\text{от И.П.}}\\
%      & = \bigsqcup_k \varphi_i(\val{\tau_1}(\bar{a}_k,\bar{\varphi}), \dots, \val{\tau_{m_i}}(\bar{a}_k,\bar{\varphi})) & \comment{\varphi_i \in \Cont{\Nat^{m_i}_\bot}{\Nat_\bot}}\\
%      & = \bigsqcup_k \val{\tau}(\bar{a}_k,\bar{\varphi}) & \comment{\text{стойност на терм}}.
%     \end{align*}
%   \end{itemize}
% \end{hint}

\begin{cor}
  \label{cr:gamma-preserves-continuous}
  Да разгледаме произволен терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
  Тогава за произволни $\varphi_i \in \Cont{\Nat^{m_i}}{\Nat_\bot}$, за $i = 1,\dots k$,
  имаме, че
  \[\Gamma_\tau(\bar\varphi) \in \RanOpCBN.\]
\end{cor}

Щом термалните оператори $\Gamma_\tau$ са добре дефинирани, ще 
проверим, че са непрекъснати. Първата стъпка ще бъде проверката, че те са монотонни.

\begin{lemma}
  \label{lem:rec:functional:term:continuous}
  Нека $\mu[\vv{f}_1,\dots,\vv{f}_k]$ е {\em функционален} терм.
  \marginpar{Да напомним, че $m_i \dff \#\vv{f}_i$}
  Да разгледаме произволна верига $\chain{\ov{\varphi}}{r}$
  от елементи на
  \[\DomOpCBN.\]
  Тогава $\val{\mu}$ е непрекъснато изображение, т.е.
  \[\val{\mu}(\bigsqcup_r\ov{\varphi}_r) = \bigsqcup_r \val{\mu}(\ov{\varphi}_r).\]
\end{lemma}
\begin{proof}
  Индукция по построението на терма $\mu$.
  \begin{itemize}
  \item
    Нека $\mu \equiv \vv{c}$. Този случай е очевиден.
  \item
    Нека $\mu \equiv \mu_1 + \mu_2$. Ще използваме, че $\texttt{plus}$ е непрекъснато изображение.
    \begin{align*}
      \val{\mu}(\bigsqcup_r \ov{\varphi}_r) & \dff \texttt{plus}(\val{\mu_1}(\bigsqcup_r\ov{\varphi}_r), \val{\mu_2}(\bigsqcup_r\ov{\varphi}_r))\\
      & = \texttt{plus}(\bigsqcup_r\val{\mu_1}(\ov{\varphi}_r), \bigsqcup_r \val{\mu_2}(\ov{\varphi}_r)) & \comment{\text{от И.П.}}\\
      & = \bigsqcup_r \texttt{plus}(\val{\mu_1}(\ov{\varphi}_r), \val{\mu_2}(\ov{\varphi}_r)) & \comment{\texttt{plus}\text{ е непр.}}\\
      & \dff \bigsqcup_r \val{\mu}(\ov{\varphi}_r).
    \end{align*}
  \item
    Нека $\mu \equiv \mu_1\ \vv{==}\ \mu_2$.
    Използвайте, че $\texttt{eq}$ е непрекъснато изображение.
  \item
    Нека $\mu \equiv \ifelse{\mu_0}{\mu_1}{\mu_2}$.
    Използвайте \Problem{rec:if:continuous}.
  \item
    Нека $\mu \equiv \vv{f}_i(\mu_1,\dots,\mu_{m_i})$. 
    От И.П. знаем, че $\val{\mu_j}$ са непрекъснати изображения за $j = 1,\dots,m_i$, а от \Prop{continuous-is-monotone}
    следва, че $\val{\mu_j}$ са монотонни. Тогава
    за произволни индекси $n \leq n'$ и $r \leq r'$ имаме, че
    \marginpar{$\ov{\varphi}_n \dff (\varphi^1_n,\dots,\varphi^{k}_n)$}
    \begin{align*}
      \varphi^i_{n}(\val{\mu_1}(\ov{\varphi}_r),\dots,\val{\mu_{m_i}}(\ov{\varphi}_r)) & \sqsubseteq \varphi^i_{n}(\val{\mu_1}(\ov{\varphi}_{r'}),\dots,\val{\mu_{m_i}}(\ov{\varphi}_{r'}))\\
                                                                                       & \sqsubseteq \varphi^i_{n'}(\val{\mu_1}(\ov{\varphi}_{r'}),\dots,\val{\mu_{m_i}}(\ov{\varphi}_{r'})).
    \end{align*}
    Това означава, че ако положим
    \[e_{n,r} \dff \varphi^i_{n}(\val{\mu_1}(\ov{\varphi}_r),\dots,\val{\mu_{m_i}}(\ov{\varphi}_r)),\]
    то
    \[n \leq n'\ \&\ r \leq r' \implies e_{n,r} \sqsubseteq e_{n',r'}.\]
    Сега можем да приложим \Th{double-chain}, според която
    \begin{equation}
      \label{eq:8}
      \bigsqcup_n(\bigsqcup_r e_{n,r}) = \bigsqcup_n e_{n,n}.
    \end{equation}

    Тогава 
    \begin{align*}
      \val{\mu}(\bigsqcup_n\ov{\varphi}_n) & = \val{\vv{f}_i(\mu_1,\dots,\mu_{m_i})}(\bigsqcup_n\ov{\varphi}_n)\\
                                           & \dff (\bigsqcup_n\varphi^i_n)(\val{\mu_1}(\bigsqcup_r\ov{\varphi}_r),\dots,\val{\mu_{m_i}}(\bigsqcup_r\ov{\varphi}_r))\\
                                           & = \bigsqcup_n \{\varphi^i_n(\val{\mu_1}(\bigsqcup_r\ov{\varphi}_r),\dots,\val{\mu_{m_i}}(\bigsqcup_r\ov{\varphi}_r))\} & \comment{\text{от \Th{monotone-is-domain}}}\\
                                           & =  \bigsqcup_n \{\varphi^i_n(\bigsqcup_r \val{\mu_1}(\ov{\varphi}_r),\dots,\bigsqcup_r \val{\mu_{m_i}}(\ov{\varphi}_r))\} & \comment{\text{от И.П. за }\mu_j}\\
                                           & =  \bigsqcup_n \{\bigsqcup_r \underbrace{\varphi^i_n(\val{\mu_1}(\ov{\varphi}_r),\dots,\val{\mu_{m_i}}(\ov{\varphi}_r))}_{e_{n,r}}\} & \comment{\varphi^i_n \text{ е непр.}}\\
                                           & =  \bigsqcup_n \underbrace{\varphi^i_n(\val{\mu_1}(\ov{\varphi}_n),\dots,\val{\mu_{m_i}}(\ov{\varphi}_n))}_{e_{n,n}} & \comment{\text{от (\ref{eq:8})}}\\
                                           & \dff \bigsqcup_n \val{\vv{f}_i(\mu_1,\dots,\mu_{m_i})}(\ov{\varphi}_n)\\
                                           & = \bigsqcup_n \val{\mu}(\ov{\varphi}_n).
    \end{align*}
  \end{itemize}
\end{proof}

\begin{cor}
  \label{cr:rec:term:continuous}
  Нека $\tau[\varsx,\varsf]$ е терм.
  Да разгледаме произволни елементи $\ov{a}$ на $\Nat^n_\bot$ и 
  произволна верига $\chain{\ov{\varphi}}{r}$
  от елементи на
  \[\DomOpCBN.\]
  Тогава 
  \[\val{\tau}(\ov{a},\bigsqcup_r\ov{\varphi}_r) = \bigsqcup_r \val{\tau}(\ov{a},\ov{\varphi}_r).\]  
\end{cor}
\begin{proof}
  \begin{align*}
    \val{\tau}(\bigsqcup_r\ov{\varphi}_r)(\ov{a}) & = \val{\tau[\varsx/\ov{\vv{a}}]}(\bigsqcup_r \ov{\varphi}_r) & \comment{\text{от \hyperref[lem:rec:substitution]{Лема за замяната}}}\\
                                                  & = \bigsqcup_r \val{\tau[\varsx/\ov{\vv{a}}]}(\ov{\varphi}_r) & \comment{\text{от \Lem{rec:functional:term:continuous}}}\\
                                                  & = \bigsqcup_r \val{\tau}(\ov{\varphi}_r)(\ov{a}) &  \comment{\text{от \hyperref[lem:rec:substitution]{Лема за замяната}}}\\
  \end{align*}
\end{proof}


% \begin{prop}
%   \label{pr:tau-preserves-monotone}
%   Да разгледаме произволен терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$.
%   Да разгледаме произволни $\ov{a} \in \Nat^n_\bot$ и $\ov{\varphi} \sqsubseteq \ov{\psi}$,
%   където $\varphi_i,\psi_i \in \Cont{\Nat^{m_i}_\bot}{\Nat_\bot}$, за $i = 1, \dots, k$.
%   Тогава 
%   \[\val{\tau}(\ov{a},\ov{\varphi}) \sqsubseteq \val{\tau}(\ov{a},\ov{\psi}).\]
% \end{prop}
% \begin{hint}
%   Отново индукция по построението на терма $\tau$, 
%   като съществено използваме \Prop{continuous-is-monotone}, което ни казва, че всяка непрекъснато изображене е монотонно.
%   \begin{itemize}
%   \item
%     Нека $\tau \equiv \vv{c}$.
%   \item
%     Нека $\tau \equiv \vv{x}_i$.
%   \item
%     Нека $\tau \equiv \tau_1 + \tau_2$.
%   \item
%     Нека $\tau \equiv \tau_1\ \vv{==}\ \tau_2$.
%   \item
%     Нека $\tau \equiv \ifelse{\tau_0}{\tau_1}{\tau_2}$.
%   \item 
%     Нека $\tau \equiv \vv{f}_i(\tau_1,\dots,\tau_{m_i})$.
%     Тогава от {\bf И.П.} имаме, че за $j = 1,\dots,m_i$,
%     \begin{equation}
%       \label{eq:7}
%       \val{\tau_j}(\ov{a},\ov{\varphi}) \sqsubseteq \val{\tau_j}(\ov{a},\ov{\psi}).      
%     \end{equation}

%     Понеже $\varphi_i$ е непрекъснато и следователно монотонно, заключаваме, че 
%     \begin{align*}
%       \val{\tau}(\ov{a},\ov{\varphi}) & = \varphi_i(\val{\tau_1}(\ov{a},\ov{\varphi}), \dots, \val{\tau_{m_i}}(\ov{a},\ov{\varphi})) & \comment{\text{стойност на терм}}\\
%                                       & \sqsubseteq \varphi_i(\val{\tau_1}(\ov{a},\ov{\psi}), \dots, \val{\tau_{m_i}}(\ov{a},\ov{\psi})) & \comment{\text{от (\ref{eq:7}) и $\varphi_i$ е мон.}}\\
%                                       & \sqsubseteq \psi_i(\val{\tau_1}(\ov{a},\ov{\psi}), \dots, \val{\tau_{m_i}}(\ov{a},\ov{\psi})) & \comment{\varphi_i \sqsubseteq \psi_i}\\
%       & = \val{\tau}(\ov{a},\ov{\psi}) & \comment{\text{стойност на терм}}.
%     \end{align*}
%   \end{itemize}
% \end{hint}

% \begin{cor}
%   За произволен терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$,
%   $\Gamma_\tau$ е монотонен оператор.
% \end{cor}

% \begin{prop}
%   \label{pr:tau-is-finite}
%   Да разгледаме един терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$ и 
%   нека $(\bar{\varphi}_r)^{\infty}_{r=0}$ е верига във $\C$,
%   \marginpar{Озн. $\ov{\varphi}_r = (\varphi^1_r,\dots,\varphi^{k}_r)$}
%   $\bar{a}\in\N^n_\bot$, и $b \neq \bot$.
%   Тогава \[\val{\tau}(\bar{a},\bigsqcup_r\bar{\varphi}_r) = b\ \iff\ \val{\tau}(\bar{a},\bar{\varphi}_{r_0}) = b\text{ за някой индекс }r_0\]
% \end{prop}
% \begin{proof}
%   Посоката $(\Leftarrow)$ следва директно от \Prop{tau-preserves-monotone},
%   защото за индекса $r_0$ имаме, че $\bar{\varphi}_{r_0} \sqsubseteq \bigsqcup_r\bar{\varphi}_{r}$, и оттук 
%   \begin{align*}
%     \bot \neq b & = \val{\tau}(\bar{a},\bar{\varphi}_{r_0}) \\
%                 & \sqsubseteq \val{\tau}(\bar{a},\bigsqcup_r\bar{\varphi}_{r}) & (\text{монотонност})\\
%                 & = b & (\text{плоска наредба и }b \neq \bot).
%   \end{align*}

%   % Понеже $b \neq \bot$ и $\sqsubseteq$ е плоската наредба, то $\val{\tau}(\bar{a},\bigsqcup_r\bar{\varphi}_{r}) = b$.
  
%   Ще докажем посоката $(\Rightarrow)$ с индукция по построението на терма $\tau$.
%   Тук трябва да внимаваме с индексите, защото означаваме $\ov{\varphi}_r = (\varphi^1_r,\dots,\varphi^{k}_r)$
%   и 
%   \[\bigsqcup_r(\varphi^1_r,\dots,\varphi^k_r) = (\bigsqcup_r\varphi^1_r,\dots,\bigsqcup_r\varphi^{k}_r).\]
%   \begin{enumerate}[a)]
%   \item
%     Нека $\tau \equiv \vv{c}$.
%   \item
%     Нека $\tau \equiv \vv{x}_i$.
%   \item
%     Нека $\tau[\varsx, \varsf] \equiv \tau_1[\varsx, \varsf] + \tau_2[\varsx, \varsf]$.
%     Нека
%     \begin{align*}
%       b_1 & \dff \val{\tau_1}(\ov{a},\bigsqcup_r\ov{\varphi}_r)\\
%       b_2 & \dff \val{\tau_2}(\ov{a},\bigsqcup_r\ov{\varphi}_r).
%     \end{align*}
%     Понеже $b \neq \bot$, то $b_1, b_1 \in \Nat$ и $b = b_1 + b_2$.
%     От {\bf И.П.} получаваме, че съществуват $r_1,r_2$, за които:
%     \begin{align*}
%       b_1 & = \val{\tau_1}(\ov{a},\bigsqcup_r\ov{\varphi}_r) = \val{\tau_1}(\ov{a},\ov{\varphi}_{r_1})\\
%       b_2 & = \val{\tau_2}(\ov{a},\bigsqcup_r\ov{\varphi}_r) = \val{\tau_1}(\ov{a},\ov{\varphi}_{r_2}).
%     \end{align*}
%     Нека $r_0 \dff \max\{r_1,r_2\}$. Тогава 
%     \begin{align*}
%       \ov{\varphi}_{r_1} \sqsubseteq \ov{\varphi}_{r_0} & \implies \val{\tau_1}(\ov{a},\ov{\varphi}_{r_1}) = \val{\tau_1}(\ov{a},\ov{\varphi}_{r_0}) = b_1 \neq \bot \\
%       \ov{\varphi}_{r_2} \sqsubseteq \ov{\varphi}_{r_0} & \implies \val{\tau_1}(\ov{a},\ov{\varphi}_{r_2}) = \val{\tau_1}(\ov{a},\ov{\varphi}_{r_0}) = b_2 \neq \bot.
%     \end{align*}
%     Накрая,
%     \begin{align*}
%       \val{\tau}(\ov{a},\bigsqcup_r\ov{\varphi}_r) & = \overbrace{\val{\tau_1}(\ov{a},\bigsqcup_r\ov{\varphi}_{r})}^{b_1 \neq \bot} + \overbrace{\val{\tau_2}(\ov{a},\bigsqcup_r\ov{\varphi}_{r})}^{b_2 \neq \bot}\\
%                                                    & = \val{\tau_1}(\ov{a},\ov{\varphi}_{r_1}) + \val{\tau_2}(\ov{a},\ov{\varphi}_{r_2})\\
%                                                    & = \val{\tau_1}(\ov{a},\ov{\varphi}_{r_0}) + \val{\tau_2}(\ov{a},\ov{\varphi}_{r_0})\\
%       & = \val{\tau}(\ov{a},\ov{\varphi}_{r_0}).
%     \end{align*}

%   \item
%     Нека $\tau \equiv \vv{f}_i(\tau_1,\dots,\tau_{m_i})$. Тогава 
%     \begin{align*}
%       \val{\tau}(\ov{a},\bigsqcup_r\ov{\varphi}_r) & = \val{\vv{f}_i(\tau_1,\dots,\tau_{m_i})}(\ov{a},\bigsqcup_r\ov{\varphi}_r)\\
%                                                      & = (\bigsqcup_r\varphi^i_r)(\overbrace{\val{\tau_1}(\ov{a},\bigsqcup_r\ov{\varphi}_r)}^{b_1},\dots,\overbrace{\val{\tau_{m_i}}(\ov{a},\bigsqcup_r\ov{\varphi}_r)}^{b_{m_i}}) & \comment{\text{стойност на терм}}\\
%                                                      & = (\bigsqcup_r\varphi^i_r)(b_1,\dots,b_{m_i}) & \comment{\text{Може някои }b_j = \bot}\\
%                                                      & = \bigsqcup\{\underbrace{\varphi^i_r(b_1,\dots,b_{m_i})}_{c_r} \mid r \in \Nat\} & \comment{\text{от \Th{continuous-is-domain}}}\\
%                                                      & = \bigsqcup\{c_0 \sqsubseteq c_1 \sqsubseteq c_2 \sqsubseteq \cdots\} & \comment{\text{защото }\varphi^{i}_{r} \sqsubseteq \varphi^{i}_{r+1}}\\
%                                                      & = b \neq \bot.
%     \end{align*}
%     Понеже $(c_r)^{\infty}_{r=0}$ е верига в $\Nat_\bot$, където работим с плоската наредба, и $\bigsqcup_r c_r = b \neq \bot$, то съществува индекс $\hat{r}$,
%     за който $\varphi^i_{\hat{r}}(\ov{b}) \dff c_{\hat{r}} = b \neq \bot$.
%     Да разгледаме сега за всяко $j = 1,\dots,m_i$,
%     \begin{itemize}
%     \item
%       Ако $b_j \neq \bot$, то използваме {\bf И.П.}:
%       \[\val{\tau_j}(\ov{a},\bigsqcup_r\ov{\varphi}_r) = b_j\ \implies\ \val{\tau_j}(\ov{a},\ov{\varphi}_{r_j}) = b_j\text{ за някой индекс }r_j\]
%       Избираме този индекс $r_j$.
%     \item
%       Ако $b_j = \bot$, то фиксираме $r_j = 42$. (Защо?)
%     \end{itemize}
%     Нека да положим
%     \[r_0 = \max\{\hat{r},r_1,\dots,r_{m_i}\}.\]
%     \marginpar{Естествено, всеки индекс $\geq r_0$ ще свърши работа}
%     Ще видим, че $r_0$ е търсения индекс. За всяко $j = 1, \dots, m_i$ получаваме:
%     \begin{itemize}
%     \item 
%       $b_j \neq \bot$, то
%       \[\ov{\varphi}_{r_j} \sqsubseteq \ov{\varphi}_{r_0} \implies \val{\tau_j}(\ov{a},\ov{\varphi}_{r_j}) = b_j \sqsubseteq \val{\tau_j}(\ov{a},\ov{\varphi}_{r_0}),\]
%       защото от \Prop{tau-preserves-monotone} имаме монотонност.
%       Понеже $b_j \neq \bot$, то $\val{\tau_j}(\ov{a},\ov{\varphi}_{r_0}) = b_j$.
%     \item
%       $b_j = \bot$, то отново използваме монотонност и получаваме, че
%       \[\ov{\varphi}_{r_0} \sqsubseteq \bigsqcup_k\ov{\varphi_k} \implies \val{\tau_j}(\ov{a}, \ov{\varphi}_{r_0}) \sqsubseteq \val{\tau_j}(\ov{a}, \bigsqcup_k\ov{\varphi}_k) = b_j = \bot.\]
%       Това означава, че $\val{\tau_j}(\ov{a}, \ov{\varphi}_{r_0}) = b_j$
%     \end{itemize}
%     Така видяхме, че за $j=1,\dots,m_i$, 
%     \begin{equation}
%       \label{eq:b-j}
%       \val{\tau_j}(\ov{a},\ov{\varphi}_{r_0}) = b_j.
%     \end{equation}
%     Освен това, понеже $r_0 \geq \hat{r}$ и $c_{\hat{r}} = b\neq \bot$ в $\Nat_\bot$,
%     то \[\varphi^i_{r_0}(b_1,\dots,b_{m_i}) \dff c_{r_0} = c_{\hat{r}} = b\neq \bot.\]
%     Получаваме, че 
%     \begin{align*}
%       \bot \neq b & = \val{\tau}(\ov{a},\bigsqcup_k\ov{\varphi}_k)\\
%                   & = (\bigsqcup_k\varphi^i_k)(b_1,\dots,b_{m_i}) & (\text{стойност на терм})\\
%                   & = \varphi^i_{\hat{r}}(b_1,\dots,b_{m_i}) & (\text{от избора на }\hat{r})\\
%                   & = \varphi^i_{\hat{r}}(\val{\tau_1}(\ov{a},\ov{\varphi}_{r_0}), \dots, \val{\tau_{m_i}}(\ov{a},\ov{\varphi}_{r_{0}})) & (\text{от Равенство \ref{eq:b-j}})\\
%                   & \sqsubseteq \varphi^i_{r_0}(\val{\tau_1}(\ov{a},\ov{\varphi}_{r_0}), \dots, \val{\tau_{m_i}}(\ov{a},\ov{\varphi}_{r_{0}})) & (r_0 \geq \hat{r})\\
%                   & = \val{\tau}(\ov{a},\ov{\varphi}_{r_0}) & (\text{стойност на терм})\\
%                   & = b & (\text{плоска наредба}).
%     \end{align*}
%   \end{enumerate}
% \end{proof}

% \begin{cor}
%   \label{cr:tau-is-continuous}
%   Да разгледаме един терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_m]$ и 
%   нека $(\bar{\varphi}_r)^{\infty}_{r=0}$ е верига във $\C$,
%   \marginpar{Озн. $\bar{\varphi}_r = (\varphi^1_r,\dots,\varphi^{m}_r)$}
%   $\bar{a}\in\N^n_\bot$. Тогава
%   \[\val{\tau}(\bar{a},\bigsqcup_r\bar{\varphi}_r) = \bigsqcup_r \val{\tau}(\bar{a},\bar{\varphi}_r).\]
% \end{cor}
% \begin{hint}
%   Имаме да разгледаме два случая.
%   \begin{itemize}
%   \item 
%     Нека $\val{\tau}(\bar{a},\bigsqcup_k\ov{\varphi}_k) = \bot$.
%     Тогава от \Prop{tau-preserves-monotone} имаме, че понеже $\varphi_r \sqsubseteq \bigsqcup_k \varphi_k$, то 
%     \[(\forall r)[\ \val{\tau}(\bar{a},\varphi_r) \sqsubseteq \val{\tau}(\bar{a},\bigsqcup_k\bar{\varphi}_k) = \bot\ ],\]
%     откъдето следва, че 
%     \[(\forall r)[\ \val{\tau}(\bar{a},\varphi_r) = \bot\ ].\]
%     Заключаваме, че в този случай, 
%     \[\bigsqcup_r \val{\tau}(\bar{a},\varphi_r) = \bot = \val{\tau}(\bar{a},\bigsqcup_r\bar{\varphi}_r).\]
%   \item
%     Нека $\val{\tau}(\bar{a},\bigsqcup_r\bar{\varphi}_r) = b \neq \bot$.
%     Тогава от \Prop{tau-is-finite} следва, че съществува индекс $r_0$, за който 
%     $\val{\tau}(\bar{a},\bar{\varphi}_{r_0}) = b$.
%     Понеже $b \neq \bot$ и работим с плоска наредба, то от \Prop{tau-preserves-monotone}, за всяко $r \geq r_0$ имаме, че
%     $\val{\tau}(\bar{a},\bar{\varphi}_{r}) = b$. Заключаваме, че $\bigsqcup_r \val{\tau}(\bar{a},\bar{\varphi}_r) = b$.    
%   \end{itemize}
% \end{hint}

Вече имаме всичко необходимо за да се убедим, че термалните оператори са непрекъснати.

\begin{framed}
\begin{thm}
  \label{th:gamma-is-continuous}
  За всеки терм $\tau[\vv{x}_1,\dots,\vv{x}_n, \vv{f}_1,\dots,\vv{f}_k]$, операторът 
  \[\Gamma_\tau: \DomOpCBN \to \RanOpCBN,\]
  дефиниран като
  \[\Gamma_\tau(\bar{\varphi})(\bar{a}) = \val{\tau}(\ov{\varphi})(\bar{a}),\]
  е непрекъснат.
\end{thm}
\end{framed}
\begin{proof}
  От \Cor{gamma-preserves-continuous} имаме, че $\Gamma_\tau$ е коректно дефиниран.
  Сега директно се позоваваме на \Cor{rec:term:continuous}.
\end{proof}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../sep-notes"
%%% End:
